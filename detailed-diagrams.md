# مخططات تفصيلية ومرئية للمشروع
## رسومات توضيحية لكل جزء من النظام

---

## 🎨 المخطط المعماري الشامل (Architecture Diagram)

```
╔══════════════════════════════════════════════════════════════════════════╗
║                           المستخدم (أنت)                                  ║
║                    يكتب أوامر في Terminal                                 ║
╚═══════════════════════════════════════════╤══════════════════════════════╝
                                            │
                                            │ أوامر طبيعية
                                            ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                            Claude Code CLI                                ║
║                    (أداة برمجة من Anthropic)                              ║
║  ┌─────────────────────────────────────────────────────────────────────┐  ║
║  │ • يحول الأوامر الطبيعية إلى API calls                              │  ║
║  │ • يعتقد أنه متصل بخدمة Anthropic الرسمية                           │  ║
║  │ • لا يعلم شيئاً عن النظام الوسيط                                   │  ║
║  └─────────────────────────────────────────────────────────────────────┘  ║
╚═══════════════════════════════════════════╤══════════════════════════════╝
                                            │
                                            │ HTTP Request
                                            │ POST /v1/chat/completions
                                            ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                   🧠 SMART ROUTER SYSTEM 🧠                               ║
║                      (النظام الوسيط الذكي)                                ║
║  ╔════════════════════════════════════════════════════════════════════╗  ║
║  ║  📥 REQUEST RECEIVER                                               ║  ║
║  ║  ┌──────────────────────────────────────────────────────────────┐  ║  ║
║  ║  │ يستقبل الطلب من Claude Code                                 │  ║  ║
║  ║  │ يتظاهر أنه API عادي                                          │  ║  ║
║  ║  └──────────────────────────────────────────────────────────────┘  ║  ║
║  ╚═══════════════════════════════╤════════════════════════════════════╝  ║
║                                  │                                        ║
║                                  ▼                                        ║
║  ╔════════════════════════════════════════════════════════════════════╗  ║
║  ║  📋 CONTEXT MANAGER                                                ║  ║
║  ║  ┌──────────────────────────────────────────────────────────────┐  ║  ║
║  ║  │ Session ID: abc-123-xyz                                      │  ║  ║
║  ║  │ ├─→ Message 1: "اشرح OOP"                                    │  ║  ║
║  ║  │ ├─→ Message 2: "Response from GLM"                           │  ║  ║
║  ║  │ ├─→ Message 3: "اكتب مثال"                                   │  ║  ║
║  ║  │ └─→ Message 4: "Response from DeepSeek"                      │  ║  ║
║  ║  │                                                               │  ║  ║
║  ║  │ يسترجع السياق ← Redis (Fast Cache)                           │  ║  ║
║  ║  │ يسترجع التاريخ ← PostgreSQL (Permanent Storage)              │  ║  ║
║  ║  └──────────────────────────────────────────────────────────────┘  ║  ║
║  ╚═══════════════════════════════╤════════════════════════════════════╝  ║
║                                  │                                        ║
║                                  ▼                                        ║
║  ╔════════════════════════════════════════════════════════════════════╗  ║
║  ║  🏷️ TASK CLASSIFIER                                                ║  ║
║  ║  ┌──────────────────────────────────────────────────────────────┐  ║  ║
║  ║  │ يحلل الطلب: "اكتب function python"                           │  ║  ║
║  ║  │                                                               │  ║  ║
║  ║  │ كلمات مفتاحية:                                               │  ║  ║
║  ║  │ ├─→ "function" ✓                                             │  ║  ║
║  ║  │ ├─→ "python" ✓                                               │  ║  ║
║  ║  │ └─→ "اكتب" ✓                                                 │  ║  ║
║  ║  │                                                               │  ║  ║
║  ║  │ التصنيف: 🖥️ CODE (Programming)                              │  ║  ║
║  ║  └──────────────────────────────────────────────────────────────┘  ║  ║
║  ╚═══════════════════════════════╤════════════════════════════════════╝  ║
║                                  │                                        ║
║                                  ▼                                        ║
║  ╔════════════════════════════════════════════════════════════════════╗  ║
║  ║  💚 HEALTH MONITOR                                                 ║  ║
║  ║  ┌──────────────────────────────────────────────────────────────┐  ║  ║
║  ║  │ Service Status:                                              │  ║  ║
║  ║  │ ├─→ Antigravity:  ✅ Healthy (99.8%)                         │  ║  ║
║  ║  │ ├─→ DeepSeek:     ✅ Healthy (98.5%)                         │  ║  ║
║  ║  │ ├─→ Qwen:         ✅ Healthy (97.2%)                         │  ║  ║
║  ║  │ ├─→ GLM:          ⚠️ Degraded (85.1%)                        │  ║  ║
║  ║  │ └─→ Kimi:         ❌ Down (0 errors: 12)                     │  ║  ║
║  ║  │                                                               │  ║  ║
║  ║  │ Available: [Antigravity, DeepSeek, Qwen, GLM]                │  ║  ║
║  ║  └──────────────────────────────────────────────────────────────┘  ║  ║
║  ╚═══════════════════════════════╤════════════════════════════════════╝  ║
║                                  │                                        ║
║                                  ▼                                        ║
║  ╔════════════════════════════════════════════════════════════════════╗  ║
║  ║  🎯 SERVICE SELECTOR                                               ║  ║
║  ║  ┌──────────────────────────────────────────────────────────────┐  ║  ║
║  ║  │ Task Type: CODE                                              │  ║  ║
║  ║  │ Preferences: [DeepSeek, Antigravity, Qwen]                   │  ║  ║
║  ║  │                                                               │  ║  ║
║  ║  │ Checking:                                                    │  ║  ║
║  ║  │ ├─→ DeepSeek available? ✅ YES                               │  ║  ║
║  ║  │ └─→ SELECTED: DeepSeek                                       │  ║  ║
║  ║  │                                                               │  ║  ║
║  ║  │ Fallback Plan:                                               │  ║  ║
║  ║  │ If fail → Try Antigravity                                    │  ║  ║
║  ║  │ If fail → Try Qwen                                           │  ║  ║
║  ║  └──────────────────────────────────────────────────────────────┘  ║  ║
║  ╚═══════════════════════════════╤════════════════════════════════════╝  ║
║                                  │                                        ║
║                                  ▼                                        ║
║  ╔════════════════════════════════════════════════════════════════════╗  ║
║  ║  📤 REQUEST BUILDER                                                ║  ║
║  ║  ┌──────────────────────────────────────────────────────────────┐  ║  ║
║  ║  │ Building API Request:                                        │  ║  ║
║  ║  │ {                                                            │  ║  ║
║  ║  │   "model": "deepseek",                                       │  ║  ║
║  ║  │   "messages": [                                              │  ║  ║
║  ║  │     {...previous context...},                               │  ║  ║
║  ║  │     {"role": "user", "content": "اكتب function"}             │  ║  ║
║  ║  │   ]                                                          │  ║  ║
║  ║  │ }                                                            │  ║  ║
║  ║  └──────────────────────────────────────────────────────────────┘  ║  ║
║  ╚═══════════════════════════════╤════════════════════════════════════╝  ║
╚════════════════════════════════════╪═════════════════════════════════════╝
                                     │
                  ┌──────────────────┼──────────────────┐
                  │                  │                  │
                  ▼                  ▼                  ▼
     ┌─────────────────┐  ┌──────────────────┐  ┌─────────────────┐
     │  ❌ Antigravity  │  │  ✅ DeepSeek     │  │  ❌ Qwen        │
     │  (Not Selected) │  │  (SELECTED)      │  │  (Not Selected) │
     └─────────────────┘  └────────┬─────────┘  └─────────────────┘
                                   │
                                   │ HTTP POST
                                   ▼
╔══════════════════════════════════════════════════════════════════════════╗
║                         🤖 DeepSeek Free API                             ║
║                      (Running in Docker)                                 ║
║  ┌────────────────────────────────────────────────────────────────────┐  ║
║  │ • يستقبل الطلب مع كامل السياق                                      │  ║
║  │ • يعالج بنموذج DeepSeek V3                                         │  ║
║  │ • يولد الإجابة (الكود البرمجي)                                     │  ║
║  │ • يرجع Response                                                    │  ║
║  └────────────────────────────────────────────────────────────────────┘  ║
╚═══════════════════════════════════╤══════════════════════════════════════╝
                                    │
                                    │ Response
                                    ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                      🧠 SMART ROUTER (Return Path)                        ║
║  ╔════════════════════════════════════════════════════════════════════╗  ║
║  ║  📥 RESPONSE HANDLER                                               ║  ║
║  ║  ┌──────────────────────────────────────────────────────────────┐  ║  ║
║  ║  │ Response received from DeepSeek                              │  ║  ║
║  ║  │ Status: 200 OK ✓                                             │  ║  ║
║  ║  │ Content: [Python code for function]                          │  ║  ║
║  ║  └──────────────────────────────────────────────────────────────┘  ║  ║
║  ╚═══════════════════════════════╤════════════════════════════════════╝  ║
║                                  │                                        ║
║                                  ▼                                        ║
║  ╔════════════════════════════════════════════════════════════════════╗  ║
║  ║  💾 DATA SAVER                                                     ║  ║
║  ║  ┌──────────────────────────────────────────────────────────────┐  ║  ║
║  ║  │ Saving to Database:                                          │  ║  ║
║  ║  │                                                               │  ║  ║
║  ║  │ User Message:                                                │  ║  ║
║  ║  │ ├─→ session_id: abc-123-xyz                                  │  ║  ║
║  ║  │ ├─→ role: user                                               │  ║  ║
║  ║  │ ├─→ content: "اكتب function"                                 │  ║  ║
║  ║  │ └─→ timestamp: 2026-02-03 14:30:00                           │  ║  ║
║  ║  │                                                               │  ║  ║
║  ║  │ Assistant Message:                                           │  ║  ║
║  ║  │ ├─→ session_id: abc-123-xyz                                  │  ║  ║
║  ║  │ ├─→ role: assistant                                          │  ║  ║
║  ║  │ ├─→ content: [Python code]                                   │  ║  ║
║  ║  │ ├─→ service_used: DeepSeek                                   │  ║  ║
║  ║  │ ├─→ tokens: 450                                              │  ║  ║
║  ║  │ └─→ timestamp: 2026-02-03 14:30:15                           │  ║  ║
║  ║  │                                                               │  ║  ║
║  ║  │ Saved to PostgreSQL ✓                                        │  ║  ║
║  ║  │ Cached in Redis ✓                                            │  ║  ║
║  ║  └──────────────────────────────────────────────────────────────┘  ║  ║
║  ╚═══════════════════════════════╤════════════════════════════════════╝  ║
║                                  │                                        ║
║                                  ▼                                        ║
║  ╔════════════════════════════════════════════════════════════════════╗  ║
║  ║  📤 RESPONSE FORMATTER                                             ║  ║
║  ║  ┌──────────────────────────────────────────────────────────────┐  ║  ║
║  ║  │ Format to OpenAI-compatible:                                 │  ║  ║
║  ║  │ {                                                            │  ║  ║
║  ║  │   "id": "abc-123-xyz",                                       │  ║  ║
║  ║  │   "choices": [{                                              │  ║  ║
║  ║  │     "message": {                                             │  ║  ║
║  ║  │       "role": "assistant",                                   │  ║  ║
║  ║  │       "content": "[Python code]"                             │  ║  ║
║  ║  │     }                                                        │  ║  ║
║  ║  │   }],                                                        │  ║  ║
║  ║  │   "usage": {"total_tokens": 450},                           │  ║  ║
║  ║  │   "service_used": "DeepSeek"  ← إضافة خاصة                  │  ║  ║
║  ║  │ }                                                            │  ║  ║
║  ║  └──────────────────────────────────────────────────────────────┘  ║  ║
║  ╚═══════════════════════════════╤════════════════════════════════════╝  ║
╚════════════════════════════════════╪═════════════════════════════════════╝
                                     │
                                     │ HTTP Response
                                     ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                            Claude Code CLI                                ║
║  ┌─────────────────────────────────────────────────────────────────────┐  ║
║  │ • يستقبل الإجابة                                                    │  ║
║  │ • يعرضها للمستخدم                                                   │  ║
║  │ • لا يعلم أنها جاءت من DeepSeek!                                   │  ║
║  └─────────────────────────────────────────────────────────────────────┘  ║
╚═══════════════════════════════════╤══════════════════════════════════════╝
                                    │
                                    ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║                          المستخدم يرى الإجابة                            ║
║                       [Python function code...]                           ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

---

## 🔄 مخطط تدفق القرارات (Decision Flow)

```
                          طلب جديد من المستخدم
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │ هل Session ID موجود؟       │
                    └──────┬──────────────┬───────┘
                          نعم            لا
                           │              │
                           │              ▼
                           │    ┌──────────────────┐
                           │    │ أنشئ Session     │
                           │    │ جديد             │
                           │    │ UUID = new()     │
                           │    └─────────┬────────┘
                           │              │
                           └──────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │ استرجع آخر 20 رسالة        │
                    │ من Redis/PostgreSQL         │
                    └──────────────┬──────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │ تحليل نوع المهمة            │
                    └──────────────┬──────────────┘
                                  │
              ┌───────────────────┼───────────────────┐
              │                   │                   │
              ▼                   ▼                   ▼
        ┌──────────┐        ┌──────────┐        ┌──────────┐
        │  برمجة   │        │نص طويل   │        │   رسم    │
        └────┬─────┘        └────┬─────┘        └────┬─────┘
             │                   │                   │
             ▼                   ▼                   ▼
      Priority List:      Priority List:      Priority List:
      1. DeepSeek         1. Kimi             1. GLM
      2. Antigravity      2. Antigravity      2. Qwen
      3. Qwen             3. Qwen             3. Antigravity
             │                   │                   │
             └───────────────────┴───────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │ فحص الخدمات المتاحة         │
                    │ من Health Monitor           │
                    └──────────────┬──────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │ Available: [A, D, Q]        │
                    │ (Antigravity, DeepSeek,     │
                    │  Qwen)                      │
                    └──────────────┬──────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │ Match Priority with         │
                    │ Available                   │
                    └──────────────┬──────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
                    ▼                           ▼
          ┌──────────────────┐      ┌──────────────────┐
          │ First Match:     │      │ No Match:        │
          │ DeepSeek ✓       │      │ Fallback to      │
          │ SELECTED         │      │ Round Robin      │
          └─────────┬────────┘      └────────┬─────────┘
                    │                        │
                    └────────────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │ بناء الطلب                  │
                    │ + دمج السياق                │
                    │ + إعدادات خاصة              │
                    └──────────────┬──────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │ إرسال للخدمة المختارة       │
                    └──────────────┬──────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    │                           │
                    ▼                           ▼
          ┌──────────────────┐      ┌──────────────────┐
          │ نجح ✓            │      │ فشل ✗            │
          │ Status: 200      │      │ Status: 500/429  │
          └─────────┬────────┘      └────────┬─────────┘
                    │                        │
                    │                        ▼
                    │              ┌──────────────────┐
                    │              │ سجل الفشل        │
                    │              │ error_count++    │
                    │              └────────┬─────────┘
                    │                       │
                    │                       ▼
                    │              ┌──────────────────┐
                    │              │ هل توجد خدمات   │
                    │              │ أخرى؟            │
                    │              └────┬──────┬──────┘
                    │                  نعم    لا
                    │                   │      │
                    │                   ▼      ▼
                    │          ┌──────────┐  ┌──────┐
                    │          │ أعد      │  │ خطأ  │
                    │          │ المحاولة│  │ نهائي│
                    │          └────┬─────┘  └──────┘
                    │               │
                    └───────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │ حفظ في قاعدة البيانات       │
                    │ - الطلب                     │
                    │ - الإجابة                   │
                    │ - الخدمة                    │
                    │ - التوقيت                   │
                    └──────────────┬──────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │ إرجاع الإجابة للمستخدم      │
                    └─────────────────────────────┘
```

---

## 📊 مخطط إدارة السياق (Context Flow)

```
╔══════════════════════════════════════════════════════════════╗
║              Context Management System                       ║
╚══════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────┐
│  طلب جديد يصل مع Session ID                                  │
│  "session_id": "abc-123-xyz"                                 │
└──────────────────────┬───────────────────────────────────────┘
                       │
                       ▼
              ┌─────────────────┐
              │ Redis Check     │
              │ (Cache Layer)   │
              └────────┬────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
        ▼ موجود                       ▼ غير موجود
┌───────────────┐             ┌──────────────────┐
│ استرجع من     │             │ استعلام من       │
│ الـ Cache      │             │ PostgreSQL        │
│ (سريع جداً)   │             │ (بطيء نسبياً)     │
└───────┬───────┘             └─────────┬────────┘
        │                               │
        │                               ▼
        │                      ┌──────────────────┐
        │                      │ حفظ في Redis     │
        │                      │ للمرة القادمة    │
        │                      └─────────┬────────┘
        │                               │
        └───────────────┬───────────────┘
                        │
                        ▼
        ┌───────────────────────────────┐
        │  Context Retrieved:           │
        │  ┌─────────────────────────┐  │
        │  │ Message 1 (User)        │  │
        │  │ "اشرح OOP"              │  │
        │  │ Time: 14:00             │  │
        │  │ Service: GLM            │  │
        │  └─────────────────────────┘  │
        │  ┌─────────────────────────┐  │
        │  │ Message 2 (Assistant)   │  │
        │  │ "OOP is..."             │  │
        │  │ Time: 14:01             │  │
        │  │ Service: GLM            │  │
        │  └─────────────────────────┘  │
        │  ┌─────────────────────────┐  │
        │  │ Message 3 (User)        │  │
        │  │ "اكتب مثال"             │  │
        │  │ Time: 14:05             │  │
        │  │ Service: DeepSeek       │  │
        │  └─────────────────────────┘  │
        │  ┌─────────────────────────┐  │
        │  │ Message 4 (Assistant)   │  │
        │  │ "class Example..."      │  │
        │  │ Time: 14:06             │  │
        │  │ Service: DeepSeek       │  │
        │  └─────────────────────────┘  │
        └───────────┬───────────────────┘
                    │
                    ▼
        ┌───────────────────────────────┐
        │ دمج مع الطلب الجديد:           │
        │                               │
        │ Previous Context (4 msgs)     │
        │        +                      │
        │ New Request                   │
        │        =                      │
        │ Full Context (5 msgs)         │
        └───────────┬───────────────────┘
                    │
                    ▼
        ┌───────────────────────────────┐
        │ التحقق من الحجم:               │
        │                               │
        │ Total tokens: 2,500           │
        │ Limit: 4,000                  │
        │ Status: ✓ OK                  │
        └───────────┬───────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼ أقل من الحد           ▼ تجاوز الحد
┌──────────────┐      ┌────────────────────┐
│ استخدم كامل  │      │ تطبيق استراتيجية   │
│ السياق       │      │ الضغط:              │
└──────┬───────┘      │                    │
       │              │ 1. إزالة الرسائل   │
       │              │    القديمة          │
       │              │ 2. تلخيص المحادثة  │
       │              │ 3. الاحتفاظ بـ 10  │
       │              │    رسائل فقط        │
       │              └─────────┬──────────┘
       │                        │
       └────────────────────────┘
                    │
                    ▼
        ┌───────────────────────────────┐
        │ إرسال للخدمة المختارة مع      │
        │ السياق الكامل/المضغوط          │
        └───────────────────────────────┘
```

---

## 🏥 مخطط مراقبة الصحة (Health Monitoring)

```
╔══════════════════════════════════════════════════════════════╗
║            Health Monitor - Periodic Checks                  ║
╚══════════════════════════════════════════════════════════════╝

        كل 60 ثانية (Cron Job)
                │
                ▼
    ┌───────────────────────────┐
    │ For Each Service:         │
    │ - Antigravity             │
    │ - DeepSeek                │
    │ - Qwen                    │
    │ - GLM                     │
    │ - Kimi                    │
    └────────┬──────────────────┘
             │
             ▼
    ┌─────────────────────────────┐
    │ إرسال Test Request:         │
    │ {                           │
    │   "model": "xxx",           │
    │   "messages": [{            │
    │     "role": "user",         │
    │     "content": "test"       │
    │   }],                       │
    │   "max_tokens": 5           │
    │ }                           │
    └────────┬────────────────────┘
             │
  ┌──────────┴──────────┐
  │                     │
  ▼                     ▼
┌─────────┐       ┌──────────┐
│ نجح ✓   │       │ فشل ✗    │
│200 OK   │       │timeout/  │
│         │       │500/404   │
└────┬────┘       └────┬─────┘
     │                 │
     ▼                 ▼
┌────────────┐   ┌────────────────┐
│UPDATE:     │   │UPDATE:         │
│is_available│   │is_available    │
│= TRUE      │   │= FALSE         │
│error_count │   │error_count++   │
│= 0         │   │success_rate--  │
│last_check  │   │last_check      │
│= NOW()     │   │= NOW()         │
└────┬───────┘   └────┬───────────┘
     │                │
     └────────┬───────┘
              │
              ▼
     ┌────────────────┐
     │ Log Result:    │
     │ [2026-02-03    │
     │  14:30:00]     │
     │ DeepSeek: ✓    │
     │ Qwen: ✓        │
     │ Kimi: ✗ (3rd   │
     │ fail)          │
     └────────────────┘

╔══════════════════════════════════════════════════════════════╗
║             Service Status Dashboard                         ║
╚══════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────┐
│ Service Name    │ Status  │ Success Rate │ Last Check      │
├─────────────────┼─────────┼──────────────┼─────────────────┤
│ Antigravity     │ ✅ UP   │ 99.8%        │ 14:30:00        │
│ DeepSeek        │ ✅ UP   │ 98.5%        │ 14:30:00        │
│ Qwen            │ ✅ UP   │ 97.2%        │ 14:30:00        │
│ GLM             │ ⚠️ SLOW │ 85.1%        │ 14:30:00        │
│ Kimi            │ ❌ DOWN │  0.0%        │ 14:28:00 (old!) │
└─────────────────┴─────────┴──────────────┴─────────────────┘

📊 Overall Health: 4/5 services healthy (80%)
```

---

## 🔄 مخطط التبديل التلقائي (Failover Flow)

```
╔══════════════════════════════════════════════════════════════╗
║            Automatic Failover Mechanism                      ║
╚══════════════════════════════════════════════════════════════╝

    المستخدم يرسل طلب "اكتب كود"
                │
                ▼
    ┌───────────────────────┐
    │ Router يختار:         │
    │ DeepSeek (الأفضل      │
    │ للبرمجة)              │
    └──────────┬────────────┘
               │
               ▼
    ┌───────────────────────┐
    │ إرسال طلب لـ          │
    │ DeepSeek              │
    └──────────┬────────────┘
               │
    ┌──────────┴──────────┐
    │                     │
    ▼                     ▼
┌─────────┐         ┌──────────┐
│ نجح ✓   │         │ فشل ✗    │
│         │         │ Error:   │
│         │         │ 429 or   │
│         │         │ timeout  │
└────┬────┘         └────┬─────┘
     │                   │
     ▼                   ▼
┌──────────┐    ┌────────────────────┐
│ إرجاع    │    │ 🚨 Failover        │
│ الإجابة  │    │ Triggered!         │
└──────────┘    └─────────┬──────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │ تسجيل الفشل:           │
              │ - Service: DeepSeek   │
              │ - Error: 429          │
              │ - Time: NOW()         │
              └─────────┬─────────────┘
                        │
                        ▼
              ┌───────────────────────┐
              │ البحث عن بديل:         │
              │                       │
              │ Priority List:        │
              │ 1. ❌ DeepSeek (فشل)  │
              │ 2. ✅ Antigravity     │
              │ 3. ✅ Qwen            │
              └─────────┬─────────────┘
                        │
                        ▼
              ┌───────────────────────┐
              │ اختيار: Antigravity   │
              │ (التالي المتاح)       │
              └─────────┬─────────────┘
                        │
                        ▼
              ┌───────────────────────┐
              │ إرسال نفس الطلب       │
              │ لـ Antigravity         │
              │ (بنفس السياق!)        │
              └─────────┬─────────────┘
                        │
              ┌─────────┴─────────┐
              │                   │
              ▼                   ▼
        ┌─────────┐         ┌──────────┐
        │ نجح ✓   │         │ فشل ✗    │
        └────┬────┘         └────┬─────┘
             │                   │
             ▼                   ▼
    ┌──────────────┐   ┌────────────────┐
    │ إرجاع الإجابة│   │ جرب Qwen      │
    │ للمستخدم      │   │ (الخيار الـ 3) │
    └──────────────┘   └────────┬───────┘
                                │
                                ▼
                       ┌────────────────┐
                       │ إذا كل الخدمات│
                       │ فشلت:          │
                       │ رسالة خطأ      │
                       │ للمستخدم       │
                       └────────────────┘

⏱️ الوقت الكلي للـ Failover: < 2 ثانية
   المستخدم لا يشعر بأي تأخير ملحوظ!
```

---

## 💾 مخطط التخزين (Storage Architecture)

```
╔══════════════════════════════════════════════════════════════╗
║              Data Storage Architecture                       ║
╚══════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────┐
│                   Application Layer                          │
│              (Smart Router System)                           │
└────────────────────┬─────────────────┬─────────────────────┘
                     │                 │
          ┌──────────┴──────┐ ┌───────┴────────┐
          │                 │ │                │
          ▼                 ▼ ▼                ▼
┌──────────────────┐  ┌────────────────────────────┐
│  Redis Cache     │  │  PostgreSQL Database       │
│  (Fast Access)   │  │  (Permanent Storage)       │
├──────────────────┤  ├────────────────────────────┤
│                  │  │                            │
│ ⚡ Use Cases:    │  │ 💾 Use Cases:              │
│                  │  │                            │
│ • Session Cache  │  │ • Full Conversation        │
│   - Last 20 msgs │  │   History                  │
│   - TTL: 1 hour  │  │ • User Profiles            │
│                  │  │ • Service Health Logs      │
│ • Quick Lookups  │  │ • Analytics Data           │
│   - Active users │  │ • Long-term Memory         │
│   - Temp data    │  │                            │
│                  │  │ 📊 Tables:                 │
│ ⚙️ Config:       │  │ • conversations            │
│ - Max Memory:    │  │ • messages                 │
│   2GB            │  │ • memory                   │
│ - Eviction:      │  │ • service_health           │
│   LRU            │  │                            │
│                  │  │ 🔗 Relationships:          │
│ 🔄 Sync:         │  │ conversation 1──────∞      │
│ Write to Redis   │  │ message                    │
│ then async to    │  │                            │
│ PostgreSQL       │  │ 📈 Indexes:                │
│                  │  │ • session_id               │
│                  │  │ • timestamp                │
│                  │  │ • service_used             │
└──────────────────┘  └────────────────────────────┘

╔══════════════════════════════════════════════════════════════╗
║              Data Flow Example                               ║
╚══════════════════════════════════════════════════════════════╝

1. رسالة جديدة تصل:
   │
   ├─→ حفظ في Redis (فوري)
   │   ├─ Key: "context:abc-123-xyz"
   │   ├─ Value: JSON array of messages
   │   └─ TTL: 3600 seconds
   │
   └─→ حفظ في PostgreSQL (غير متزامن)
       ├─ INSERT INTO messages (...)
       └─ UPDATE conversations SET updated_at = NOW()

2. قراءة السياق:
   │
   ├─→ البحث في Redis أولاً
   │   ├─ HIT ✓ → إرجاع فوري (< 10ms)
   │   └─ MISS ✗ → البحث في PostgreSQL
   │
   └─→ PostgreSQL Query
       ├─ SELECT * FROM messages WHERE ...
       ├─ نسخ النتيجة إلى Redis
       └─ إرجاع (~ 50-100ms)

3. التنظيف:
   │
   ├─→ Redis: تلقائي عبر TTL
   │
   └─→ PostgreSQL: Cron job يومي
       └─ DELETE messages older than 90 days
```

---

## 🎯 مخطط توزيع المهام (Task Distribution)

```
╔══════════════════════════════════════════════════════════════╗
║         Smart Task Distribution Matrix                       ║
╚══════════════════════════════════════════════════════════════╝

┌─────────────┬──────────────┬──────────────┬──────────────┐
│  Task Type  │   Priority 1 │   Priority 2 │   Priority 3 │
├─────────────┼──────────────┼──────────────┼──────────────┤
│             │              │              │              │
│ 🖥️ CODE     │  DeepSeek    │  Antigravity │  Qwen        │
│ برمجة       │  (R1 Model)  │  (Gemini Pro)│  (Qwen Max)  │
│             │              │              │              │
│ Why?        │ Specialized  │ Multi-lang   │ Good at      │
│             │ in code      │ code support │ Chinese code │
│             │              │              │              │
├─────────────┼──────────────┼──────────────┼──────────────┤
│             │              │              │              │
│ 🤔 THINKING │  DeepSeek    │  Antigravity │  GLM         │
│ تفكير عميق  │  (R1 Think)  │  (Claude)    │  (Zero)      │
│             │              │              │              │
│ Why?        │ Deep         │ Strong       │ Reasoning    │
│             │ reasoning    │ analysis     │ capable      │
│             │              │              │              │
├─────────────┼──────────────┼──────────────┼──────────────┤
│             │              │              │              │
│ 📄 LONG     │  Kimi        │  Antigravity │  Qwen        │
│ نصوص طويلة  │  (200K ctx)  │  (100K ctx)  │  (32K ctx)   │
│             │              │              │              │
│ Why?        │ Largest      │ Second best  │ Decent       │
│             │ context      │ context      │ context      │
│             │              │              │              │
├─────────────┼──────────────┼──────────────┼──────────────┤
│             │              │              │              │
│ 🎨 IMAGE    │  GLM         │  Qwen        │  Antigravity │
│ رسم / توليد │  (CogView 3) │  (Wanxiang)  │  (Gemini)    │
│             │              │              │              │
│ Why?        │ Best image   │ Good quality │ Basic image  │
│             │ generator    │ Chinese art  │ support      │
│             │              │              │              │
├─────────────┼──────────────┼──────────────┼──────────────┤
│             │              │              │              │
│ 🔍 SEARCH   │  Qwen        │  Kimi        │  Antigravity │
│ بحث إنترنت  │  (Native)    │  (Native)    │  (Plugin)    │
│             │              │              │              │
│ Why?        │ Built-in     │ Built-in     │ Supports     │
│             │ search       │ search       │ web tools    │
│             │              │              │              │
├─────────────┼──────────────┼──────────────┼──────────────┤
│             │              │              │              │
│ 🤖 AGENT    │  GLM         │  Antigravity │  DeepSeek    │
│ وكيل ذكي    │  (Native)    │  (MCP)       │  (Tools)     │
│             │              │              │              │
│ Why?        │ Agent-first  │ Plugin       │ Tool-calling │
│             │ design       │ system       │ capable      │
│             │              │              │              │
├─────────────┼──────────────┼──────────────┼──────────────┤
│             │              │              │              │
│ 💬 GENERAL  │  Round Robin │  Round Robin │  Round Robin │
│ محادثة عامة │  All Services│  All Services│  All Services│
│             │              │              │              │
│ Why?        │ Distribute   │ Balance load │  Maximize    │
│             │ evenly       │ across all   │  usage       │
│             │              │              │              │
└─────────────┴──────────────┴──────────────┴──────────────┘

📊 Statistics (Example Week):
┌──────────────┬─────────┬──────────┐
│ Service      │ Requests│ % Total  │
├──────────────┼─────────┼──────────┤
│ DeepSeek     │  1,240  │  31%     │
│ Antigravity  │    980  │  24%     │
│ Qwen         │    750  │  19%     │
│ GLM          │    650  │  16%     │
│ Kimi         │    380  │  10%     │
├──────────────┼─────────┼──────────┤
│ Total        │  4,000  │ 100%     │
└──────────────┴─────────┴──────────┘
```

---

## 🔐 مخطط الأمان والتوكنات (Security & Tokens)

```
╔══════════════════════════════════════════════════════════════╗
║              Token Management & Security                     ║
╚══════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────┐
│                   Configuration File                         │
│              ~/.router-config/tokens.json                    │
├──────────────────────────────────────────────────────────────┤
│ {                                                            │
│   "services": {                                              │
│     "antigravity": {                                         │
│       "api_key": "sk-antigravity-001",                       │
│       "enabled": true,                                       │
│       "priority": 1                                          │
│     },                                                       │
│     "deepseek": {                                            │
│       "token": "Bearer eyJhbG...",                           │
│       "enabled": true,                                       │
│       "priority": 1                                          │
│     },                                                       │
│     "qwen": {                                                │
│       "token": "Bearer tongyi_sso...",                       │
│       "enabled": true,                                       │
│       "priority": 2                                          │
│     },                                                       │
│     "glm": {                                                 │
│       "token": "Bearer chatglm_refresh...",                  │
│       "enabled": true,                                       │
│       "priority": 2                                          │
│     },                                                       │
│     "kimi": {                                                │
│       "token": "Bearer refresh...",                          │
│       "enabled": false,  ← معطل                             │
│       "priority": 3                                          │
│     }                                                        │
│   },                                                         │
│   "security": {                                              │
│     "encrypt_tokens": true,                                  │
│     "token_rotation": true,                                  │
│     "rotation_days": 30                                      │
│   }                                                          │
│ }                                                            │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│              Token Validation Flow                           │
└──────────────────────────────────────────────────────────────┘

    عند إرسال طلب لخدمة:
            │
            ▼
    ┌───────────────────┐
    │ قراءة التوكن من    │
    │ ملف الإعدادات      │
    └─────────┬─────────┘
              │
              ▼
    ┌───────────────────┐
    │ هل التوكن مشفر؟   │
    └──────┬──────┬─────┘
          نعم    لا
           │      │
           ▼      ▼
    ┌──────────┐ │
    │ فك التشفير│ │
    └─────┬────┘ │
          └──────┘
              │
              ▼
    ┌───────────────────┐
    │ إضافة للـ Header:  │
    │ Authorization:    │
    │ Bearer TOKEN      │
    └─────────┬─────────┘
              │
              ▼
    ┌───────────────────┐
    │ إرسال للخدمة      │
    └─────────┬─────────┘
              │
    ┌─────────┴─────────┐
    │                   │
    ▼ صحيح              ▼ خطأ
┌──────────┐      ┌────────────┐
│ استمرار  │      │ 401        │
│          │      │ Unauthorized│
│          │      └─────┬──────┘
│          │            │
│          │            ▼
│          │   ┌────────────────┐
│          │   │ تعطيل الخدمة   │
│          │   │ مؤقتاً          │
│          │   │ + إشعار للمدير │
│          │   └────────────────┘
└──────────┘

🔐 Security Best Practices:
├─ تشفير التوكنات في الملف
├─ عدم تخزين التوكنات في Git
├─ تدوير التوكنات كل 30 يوم
├─ مراقبة محاولات الوصول الفاشلة
└─ تسجيل كل العمليات
```

---

**هل تريد توضيحات إضافية لأي جزء من المخططات؟** 🤔
